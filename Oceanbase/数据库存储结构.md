# 存储器的存储层次
![[Pasted image 20231001184151.png]]

存储方式的具体差异请参考下表：

|存储器|容量|特点|
|:--|:--|:--|
|高速缓存存储器|1-6 MB|高速缓存和处理器间速度为 < 10 纳秒<br>高速缓存和主存储器间速度为 10-100 纳秒|
|主存储器（内存）|10GB 以上|随机访问，访问时间 10-100 纳秒|
|辅助存储器（磁盘/固态硬盘）|1TB-10TB|数据传输：一次 < 10ms|
|第三级存储（磁带/DVD 光盘）|PT 级别|成本低、速度慢（s/min）|

# 磁盘存储器
![[Pasted image 20231001184250.png]]
上图描述了磁盘的整体结构。磁盘由多个盘片组成，其中一个盘片有正反两个盘面，每个盘面上有一个磁头，盘片的每个盘面被划分成多个同心圆，也就是磁道，每个磁道又被划分成若干弧段， 每段称为一个扇区。柱面是指不同盘面上相同磁道编号的组合，簇是指物理相邻的若干个扇区。

## 磁盘空间计算
磁盘空间主要通过以下 4 个属性计算得出：
- 盘面数量
- 磁道数量
- 扇区数量
- 扇区大小

例如，某磁盘具有以下属性：
- 8 个盘片，16 个盘面。
- 每个盘面有 2^16=65536 个磁道。
- 每个磁道 256 个扇区。
- 每个扇区 4096 个字节。

那么这块磁盘总空间为：16 × 65536 × 256 × 4096Bytes = 1TB

# 块与记录组织
- 记录：按照若干个字段元素组成的数据集合。
- 数据块：由多个数据记录元素组成的一个数据集合，在物理上对应的是一块连续的存储空间。

## 记录的存储结构
![[Pasted image 20231001185419.png]]
数据按字节对齐进行存储。同时还会额外存储这条记录的元数据信息，并且会把这些元数据信息放到记录最开始的位置，这部分内容称为记录的 header。

header 中存放的元数据信息主要有变长字段的偏移、字段的长度、记录最后修改的时间戳等（不同场景的记录需要存储的元数据可能是不一样的）。header 之后是具体每个字段的内容，这些内容一般叫做 data，data 中的内容会按照表结构的定义进行编排，因此一条完整的记录是按照 header + data 来存储的。

## 块的存储结构
块在存储中的组织与记录类似，可以简单地看成是由 header + data 数据组成，例如一个块要管理内部所有的记录，需要在块的 header 中保存每个记录的偏移、块最后修改的时间戳、块在存储结构中的位置信息。

这里需要强调的是，块里面存储的地址偏移是相对于虚拟地址的偏移，并非实际物理磁盘的偏移。还需要注意，新插入的记录，是从块的末端往中间增长的，而未使用的空间是从 header 之后往块的末端增长的。
![[Pasted image 20231001185637.png]]

# 变长数据和记录
变长记录主要分为以下几种类型：
- 大小变化的数据项
    字段中含有 varchar 等不定长字段。
- 重复字段
    一行记录中一个字段重复出现多次，但重复的次数没有规律。
- 可变格式记录
    不知道记录中有哪些字段、字段是否有重复、字段的类型、字段的长度等，例如 XML 类型的数据。
- 大字段
    通常说的 blob 字段，可能需要几个块链接在一起存储。

变长字段：记录中先存定长再存变长
重复字段：类似变长字段，也可以采用索引存储
可变格式字段：记录标识、类型、长度，读取时通过标识和类型解析数据
大字段：需要保存指向下一字段的指针

## 列存储
简单介绍列存概念
![[Pasted image 20231002143252.png]]
- 行存
    简单来说就是按行存储，例如上图有一张表，表结构中有 X Y Z 三个字段，表中插入了三条记录。如图中黄色是行存的形式，可以看到数据是按照表结构的行来存储的，大部分传统的关系型数据库都是以行存为基础。
- 列存
    列存顾名思义是按照表结构的列来存储，如上图中蓝色是列存的形式。

可能有人会有疑问，如果插入了很多行记录，按照列存会不会导致一列的数据非常大？当然是会的，但是数据库会把这一列使用多个存储单元进行存储，甚至可能跨越多个磁盘。

即便这样，列存也有天然的优势，例如因为列值的类型都一样，列存天然适合做数据压缩，这对于控制存储成本是非常有利的。再者，我们可能只针对某几列的数据进行数据分析，因此列存也非常合适 AP 系统。列存的具体优缺点如下：

优点：
- 按需读取列，减少非必要数据的访问。
- 列字段类型统一，非常利于做压缩。
- 利于做列的聚合操作。
- 适合做大数据分析，AP 性能好。

缺点：
- 写入/更新耗时相对行存较长，TP 性能差。
- 不适合做频繁的删除操作。

# 记录的修改
