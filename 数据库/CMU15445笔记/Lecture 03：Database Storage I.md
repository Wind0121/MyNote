# 引言
## Disk Manager
这就是数据库需要在磁盘上做的工作：
- DBMS 假定数据库的主要存储位置在非易失性磁盘上。
- DBMS 的组件管理数据在非易失性和易失性存储之间的移动。

![[Pasted image 20231030171851.png]]
经典老图，越接近下层，速度越慢，越接近上层，速度越快。

## 顺序访问与随机访问对比
![[Pasted image 20231030182218.png]]
很显然顺序访问比随机访问快得多，因而我们要尽可能减少随机访问。

## 数据库设计目标
1. 允许 DBMS 管理超出可用内存量的数据库。
2. 读取/写入磁盘的成本很高，因此必须小心管理，以避免出现大量停滞和性能下降。
3. 磁盘上的随机存取通常比顺序存取慢得多，因此 DBMS 希望最大限度地提高顺序存取速度。

## 不要依赖OS
![[Pasted image 20231030183927.png]]
1. 操作系统可能随时换掉脏页面，从而导致事务处理问题
2. 由于数据库系统不知道内存中有哪些页面，这就可能导致需要等待页面加载到内存中，进而导致线程停滞
3. 如果需要操作系统，就需要处理操作系统提供的一系列信号
4. 操作系统性能没那么好

我们希望在存储与查询这件事上，数据库能比操作系统做的更好。

## 数据库存储两个问题
1. DBMS 如何在磁盘文件中表示数据库。（本次课）
2. DBMS 如何管理内存并从磁盘来回移动数据。（下次课）

# File Storage
这一节主要讲述数据库系统中的文件存储：
- 文件存储包含如何在磁盘上组织文件、文件格式等
- 每个数据库都有专用的文件格式
- 操作系统可以看到文件，但无法了解这些文件有什么用

## Page
page是固定大小的数据块：
- 它可以包含元组、元数据、索引、日志记录
- 大多数系统不会在同一个页上混着存储多种数据
- 有些系统要求页包含管理存储数据的元数据（meta data）
- 每个页都会有独立id

**page的类型**
![[Pasted image 20231030190246.png]]
1. 硬件页：这是存储设备本身的存储单位，可以保证原子性的写入和读出
2. 操作系统页：这是操作系统文件系统的页
3. 数据库页：数据库页大小不定，如果大于硬件页大小，我们就需要额外的手段保证我们每次写入或读出一个数据库页是原子性的

## Heap File
Heap File是一个无序的page集合，其中的tuple以随机顺序存储：
- 如果一个数据库只有一个Heap File，那么显然我们只要有页面ID，我们就能轻松从Heap File中获取该页面
- 如果一个数据库有多个Heap File，那么我们还面临在哪个Heap File中找到page的问题。

我们需要设置特殊page，用于存储哪些Heap File存储了哪些内容，这就是directory。除此以外，这些directory还需要存储一些meta-data，用于管理page。
![[Pasted image 20231030191830.png]]

# Page Layout
对于任何页面存储架构，我们现在都需要决定如何组织页面内部的数据。 

最经典的组织架构：
![[Pasted image 20231030194135.png]]
每个槽（slot）将会追踪page存储的每一个tuple。每个tuple将会分配一个独立的id，通常就可以通过这个id得知该tuple在page中的存储位置。

![[Pasted image 20231030194546.png]]
在这个例子中，我们就可以查询一张表中每一个tuple对应的file、page、slot。可以看到删除其中一项后，slot并不会立即改变，如果执行“垃圾回收”功能，就可以看到slot前移，对应的tuple在page中也前移。

# Tuple Layout
tuple本质上是一个字节序列。数据库管理系统的工作就是将这些字节解释为属性类型和值。 

![[Pasted image 20231030195631.png]]
实际上就是每个tuple自己也会有一个header，用于解释这里边存了什么东西

