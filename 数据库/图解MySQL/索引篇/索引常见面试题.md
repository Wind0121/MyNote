# 什么是索引
索引的定义就是帮助存储引擎快速获取数据的一种数据结构，形象的说就是**索引是数据的目录**。

所谓的存储引擎，说白了就是如何存储数据、如何为存储的数据建立索引和如何更新、查询数据等技术的实现方法。

# 索引的分类
我们可以按照四个角度来分类索引：
- 按「数据结构」分类：**B+tree索引、Hash索引、Full-text索引**。
- 按「物理存储」分类：**聚簇索引（主键索引）、二级索引（辅助索引）**。
- 按「字段特性」分类：**主键索引、唯一索引、普通索引、前缀索引**。
- 按「字段个数」分类：**单列索引、联合索引**。

## 主键索引与二级索引
主键索引的 B+Tree 和二级索引的 B+Tree 区别如下：
- 主键索引的 B+Tree 的叶子节点存放的是实际数据，所有完整的用户记录都存放在主键索引的 B+Tree 的叶子节点里；
- 二级索引的 B+Tree 的叶子节点存放的是主键值，而不是实际数据。

当使用二级索引进行查询时，首先会通过二级索引找到主键值，然后通过主键索引获取整行数据。**这个过程叫「回表」，也就是说要查两个 B+Tree 才能查到数据**。

## 联合索引
通过将多个字段组合成一个索引，该索引就被称为联合索引。联合索引按从左到右的顺序对字段进行排序，因而存在**最左匹配原则**，也就是按照最左优先的方式进行索引的匹配。

**联合索引范围查询**
Q1: `select * from t_table where a > 1 and b = 2`，联合索引（a, b）哪一个字段用到了联合索引的 B+Tree？
>在符合 a > 1 条件的二级索引记录的范围里，b 字段的值是无序的。因此，Q1 这条查询语句只有 a 字段用到了联合索引进行索引查询，而 b 字段并没有使用到联合索引。

Q2: `select * from t_table where a >= 1 and b = 2`，联合索引（a, b）哪一个字段用到了联合索引的 B+Tree？
>对于符合 a = 1 的二级索引记录的范围里，b 字段的值是「有序」的。所以，Q2 这条查询语句 a 和 b 字段都用到了联合索引进行索引查询。

**索引下推**
对于联合索引（a, b），在执行 `select * from table where a > 1 and b = 2` 语句的时候，只有 a 字段能用到索引。但我们可以利用联合索引进行条件过滤，这样就可以减少**回表**的次数。

**联合索引进行排序**
Q1：`select * from order where status = 1 order by create_time asc`如何使用索引来提高查询效率。
>可以建立一个status和create_time的联合索引，由于最左匹配原则，会先匹配status=1的数据，然后联合索引会直接在局部保证create_time的有序性。

# 索引使用场景
索引最大的好处是提高查询速度，但是索引也是有缺点的，比如：
- 需要占用物理空间，数量越大，占用空间越大；
- 创建索引和维护索引要耗费时间，这种时间随着数据量的增加而增大；
- 会降低表的增删改的效率，因为每次增删改索引，B+ 树为了维护索引有序性，都需要进行动态维护。
所以，索引不是万能钥匙，它也是根据场景来使用的。

## 适用场景
- 字段有唯一性限制的，比如商品编码；
- 经常用于 `WHERE` 查询条件的字段，这样能够提高整个表的查询速度
- 经常用于 `GROUP BY` 和 `ORDER BY` 的字段，这样在查询的时候就不需要再去做一次排序了，因为我们都已经知道了建立索引之后在 B+Tree 中的记录都是排序好的。

## 不适用场景
- `WHERE` 条件，`GROUP BY`，`ORDER BY` 里用不到的字段。
- 字段中存在大量重复数据，不需要创建索引，比如性别字段，只有男女。
- 经常更新的字段不用创建索引，比如不要对电商项目的用户余额建立索引
- 表数据太少的时候，不需要创建索引；

# 优化索引的方式
## 前缀索引优化
- 前缀索引顾名思义就是使用某个字段中字符串的前几个字符建立索引
- 使用前缀索引是为了减小索引字段大小，可以增加一个索引页中存储的索引值，有效提高索引的查询速度。
- 在一些大字符串的字段作为索引时，使用前缀索引可以帮助我们减小索引项的大小。

## 覆盖索引优化
覆盖索引是指 SQL 中 query 的所有字段，在索引 B+Tree 的叶子节点上都能找得到的那些索引，从二级索引中查询得到记录，而不需要通过主键索引查询获得，可以避免回表的操作。

# 防止索引失效
发生索引失效的情况：
- 当我们使用左或者左右模糊匹配的时候，也就是 `like %xx` 或者 `like %xx%`这两种方式都会造成索引失效；
- 当我们在查询条件中对索引列做了计算、函数、类型转换操作，这些情况下都会造成索引失效；
- 联合索引要能正确使用需要遵循最左匹配原则，也就是按照最左优先的方式进行索引的匹配，否则就会导致索引失效。
- 在 WHERE 子句中，如果在 OR 前的条件列是索引列，而在 OR 后的条件列不是索引列，那么索引会失效。

