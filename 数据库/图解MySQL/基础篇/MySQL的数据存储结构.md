# MySQL的数据存在哪个文件
MySQL 存储的行为是由存储引擎实现的，MySQL 支持多种存储引擎，不同的存储引擎保存的文件自然也不同。InnoDB 是 MySQL 默认的存储引擎。

MySQL每创建一个 database（数据库） 都会在 /var/lib/mysql/ 目录里面创建一个以 database 为名的目录，然后保存表结构和表数据的文件都会存放在这个目录里。这个目录中会有以下几种文件：
- db.opt，用来存储当前数据库的默认字符集和字符校验规则。
- xxx.frm ，xxx 的表结构会保存在这个文件。在 MySQL 中建立一张表都会生成一个.frm 文件，该文件是用来保存每个表的元数据信息的，主要包含表结构定义。
- xxx.ibd，xxx 的表数据会保存在这个文件。

# InnoDB的行格式
InnoDB 提供了 4 种行格式，分别是 Redundant、Compact、Dynamic和 Compressed 行格式。这里只讲Compact格式。

Compact格式如下，一条完整的记录分为「记录的额外信息」和「记录的真实数据」两个部分。
![[Pasted image 20231220172808.png]]
# 记录的额外信息
记录的额外信息包含 3 个部分：变长字段长度列表、NULL 值列表、记录头信息。

## 变长字段长度列表
- 变长字段存储的数据长度不定，因而需要在变长字段长度列表中存储数据占用的大小。
- 变长字段的真实数据占用的字节数会按照列的顺序**逆序存放**
- **之所以逆序存放**是因为记录头信息中指向下一条记录的指针，实际是指向下一条记录的「记录头信息」和「真实数据」之间的位置，这样的好处是向左读就是记录头信息，向右读就是真实数据，比较方便。

例子如下：
![[Pasted image 20231220173118.png]]
name和phone都是变长字段，其中第一条数据的name长度为0x01、phone长度为0x03，相应的行格式如下：
![[Pasted image 20231220173206.png]]

当数据表**没有变长字段的时候**，比如全部都是 int 类型的字段，这时候表里的行格式就不会有「变长字段长度列表」了，因为没必要，不如去掉以节省空间。

## NULL值列表
NULL值列表采用位图的形式，每一个bit位表示某一列是否为NULL，与变长字段列表一样采用与列顺序相反的顺序存放。例子如下：
![[Pasted image 20231220173615.png]]
上述第三条记录的phone和age都为null，因而逆序存放的位图标注为1，表示为NULL。

当数据表的字段都定义成 **NOT NULL** 的时候，这时候表里的行格式就不会有 NULL 值列表了。

## 记录头信息
记录头信息中包含的内容很多，这里说几个比较重要的：
- delete_mask ：标识此条数据是否被删除。从这里可以知道，我们执行 detele 删除记录的时候，并不会真正的删除记录，只是将这个记录的 delete_mask 标记为 1。
- next_record：下一条记录的位置。从这里可以知道，记录与记录之间是通过链表组织的。在前面我也提到了，指向的是下一条记录的「记录头信息」和「真实数据」之间的位置，这样的好处是向左读就是记录头信息，向右读就是真实数据，比较方便。
- record_type：表示当前记录的类型，0表示普通记录，1表示B+树非叶子节点记录，2表示最小记录，3表示最大记录

# 记录的真实数据
记录真实数据部分除了我们定义的字段，还有三个隐藏字段，分别为：row_id、trx_id、roll_pointer，我们来看下这三个字段是什么。
![[Pasted image 20231220173846.png]]

## row_id
row_id是隐藏的主键列，如果建表时指定了主键或唯一约束列，该字段就不存在。

## trx_id
事务id，表示这个数据是由哪个事务生成的。 trx_id是必需的，占用 6 个字节。

## roll_ptr
这条记录上一个版本的指针。roll_pointer 是必需的，占用 7 个字节。这里涉及MVCC的内容。

# 一行数据的最大存储
一行数据的最大字节数是 65535字节，这其中包含了「变长字段长度列表」、「NULL 值列表」、「列值」。

# 行溢出的情况
如果一个数据页存不了一条记录，InnoDB 存储引擎会自动将溢出的数据存放到「溢出页」中。在一般情况下，InnoDB 的数据都是存放在 「数据页」中。但是当发生行溢出时，溢出的数据会存放到「溢出页」中。

当发生行溢出时，在记录的真实数据处只会保存该列的一部分数据，而把剩余的数据放在「溢出页」中，然后真实数据处用 20 字节存储指向溢出页的地址，从而可以找到剩余数据所在的页。大致如下图所示。
![[Pasted image 20231220174500.png]]

