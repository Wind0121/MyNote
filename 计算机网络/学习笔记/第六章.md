# 引论和服务
## 一些术语
- nodes：主机、路由器、交换机、网桥都称为节点
- links：沿着通信路径，连接个相邻节点通信信道的是链路
- frame：协议数据单元帧，用于封装数据报

## 链路层服务例子
![[Pasted image 20231015094315.png]]

## 链路层服务
![[Pasted image 20231015095106.png]]
![[Pasted image 20231015095116.png]]
![[Pasted image 20231015095126.png]]

## 链路层在哪实现
![[Pasted image 20231015100527.png]]
![[Pasted image 20231015100845.png]]
网卡中的物理层功能将帧中的每一个比特转变为物理信号发送出去。

# 差错检测和纠正
感觉不是重点，没必要听了。

# 多点访问协议
广域网通常采用点对点的链路，也就不存在多点访问控制的问题。

局域网则有多点访问的情况，如果2个或更多站点同时传送，就会产生冲突（collision），多个信号叠加最终导致信号不可用。因而需要用到多路访问协议（介质访问控制协议：MAC ）

MAC解决的就是节点什么时候可以发送、如何使用共享信道。

## 理想的多路访问协议
 1. 当一个节点要发送时，可以R速率发送
 2. 当M个节点要发送，每个可以以R/M的平均速 率发送 
 3. 完全分布的：没有特殊节点协调发送，没有时钟和时隙的同步 
 4. 简单

## 信道划分MAC协议：TDMA
![[Pasted image 20231015105709.png]]
每个节点都占用固定的时隙，无论有没有帧需要传输，周期中都会进行保留

## 信道划分MAC协议：FDMA
![[Pasted image 20231015105825.png]]
和时分复用一样，都存在空闲的问题。

## 信道划分MAC协议：CDMA
![[Pasted image 20231015110136.png]]
3G使用的技术，因而已经是过时了的

## 随机存取MAC协议
当节点有帧要发送时：
- 以信道带宽的全部 R bps发送
- 没有节点间的预先协调

两个节点发生冲突时，就会做出以下操作：
- 检测冲突
- 从冲突中恢复

## 随机存取MAC协议：时隙ALOHA
![[Pasted image 20231015112342.png]]
很显然，概率上没法保证节点最终传输成功的上限

这里是一个例子：
1. 三个节点冲突
2. 三个节点都决定不发
3. 1、2节点决定发，冲突
4. 只有2节点决定发，成功
5. 1、3节点都决定不发
6. 1、3节点都决定发，冲突
7. 1、3节点都决定不发
8. 1节点决定发，成功
9. 3节点决定发，成功
![[Pasted image 20231015112945.png]]
这里需要与信道划分的TDMA进行区分，TDMA将时间进行划分，相当于所有节点在一秒内共享发送，那么获得的发送速率就是划分后的速率。而这里使用的是时隙，是在这个时隙中占用整个带宽，因而可以全速传输。

缺点中的必须传完：节点冲突时还是会将帧全部传完，这就导致了信道的浪费

![[Pasted image 20231015114452.png]]
这个计算过程比较简单

## 随机存取MAC协议：纯ALOHA
![[Pasted image 20231015120139.png]]
相比于时隙ALOHA的同步时间情况，这样更容易发生碰撞。
![[Pasted image 20231015120150.png]]

## 随机存取MAC协议： CSMA(载波侦听多路访问)
![[Pasted image 20231016082407.png]]

这样做仍然可能产生冲突，且看下图：横轴是空间，纵轴是时间。两个节点之间存在传播延迟，导致节点侦听时，帧还没有传输到这里，也就误认为信道是空闲的。

因而传播延迟越大，冲突的概率也就越大（越难侦听）
![[Pasted image 20231016083204.png]]

## 随机存取MAC协议： CSMA/CD(冲突检测)
![[Pasted image 20231016083722.png]]
CSMA的改进版：
- 主要用于有线局域网
- 通过检测冲突，及时停止发送，从而减少信道浪费

可以这么看这张图，随着纵轴时间推移，两个节点都向外发送数据，在对方数据到达后，侦听一段时间，确认是冲突后，便两个节点都停止发送，从而减少信道浪费。对比之下，之前的纯CSMA是要发送完整个数据的。
![[Pasted image 20231016083822.png]]


实际中的算法还有第四步，在停止发送时，还要发送一个Jam（增强信号），让所有听到适配器知道当前正在冲突。

这张ppt还有一个**错误**：二进制指数退避算法中，应该是$2^m - 1$。
![[Pasted image 20231016084359.png]]

这个式子的推导超出了本书范围，因而也只是一个近似式，但基本符合直觉：
- $t_{prop}$ 变为0时，传输延时为0，那么就不会发生冲突
- $t_{trans}$变为无穷时，发送方发送帧将一直占用信道，因而效率为1。
![[Pasted image 20231016085906.png]]

## 随机存取MAC协议：CSMA/CA（冲突避免）
特点：
- 主要用于无线局域网
- 主要采用冲突避免

无线网络中，信号强度随着传输距离不断减小，也就没办法像CSMA/CD中通过侦听信号强度来判断是否冲突。因而无线网络中只能采取冲突避免的策略。

无线局域网的特点：即使没有冲突，也不代表成功发送。该ppt左下图已经表明，A、C没有侦听到冲突，因而进行发送，但他们在B处冲突，导致发送失败。

因而可以总结无线局域网中：
- 无法做CD
- 做了CD也没用
![[Pasted image 20231016091843.png]]

由于CSMA/CA没有冲突检测，因而必须引入确认机制，这样才能确保自己发送成功。
对比CSMA/CD，因为冲突检测的存在，只要发送完毕，就可以确认发送成功。

另一方面，由于无线链路不可靠，需要在链路层引入可靠机制。

通过引入ACK机制，事实上就完成了CSMA/CA的实用性。
![[Pasted image 20231016093930.png]]

![[Pasted image 20231016095558.png]]
![[Pasted image 20231016100343.png]]

**信道划分与随机存取MAC协议对比**
![[Pasted image 20231016102226.png]]

## 轮流MAC协议
![[Pasted image 20231016102341.png]]
![[Pasted image 20231016102357.png]]


# 交换局域网（LAN）
## MAC地址
![[Pasted image 20231018083825.png]]
我们要明确两个观点：
- IP地址用于主机到主机之间的寻址，要跨越多个子网
- MAC地址用于节点到节点之间的寻址，用于一个物理网络内的寻址

我们光有IP地址还不够，为了在链路层传输帧，我们需要有MAC地址在标识物理网络中的节点。

![[Pasted image 20231018084436.png]]
分离的好处：
- 网卡坏了，IP不变，可以捆绑到另外一个网卡的MAC上
- 物理网络还可以除IP之外支持其他网络层协议， 链路协议为任意上层网络协议， 如IPX等

捆绑的问题：
- 如果仅仅使用IP地址，不用MAC地址，那么它仅支持IP协议
- 每次上电都要重新写入网卡IP地址
- 如果不用MAC地址，则每到来一个帧都要上传到IP层次，由它判断是不是需要接受。如果有MAC地址，就可以在链路层通过网卡硬件判断是否需要接受。

## ARP
![[Pasted image 20231018090121.png]]

**同一个LAN（网络）内的ARP运作**
加入A要发送帧给B（B的IP地址 已知），但B的MAC地址不在A的ARP表中：
1. A广播包含B的IP地址的ARP查询包
	- 广播地址为 FF-FF-FF-FF-FF-FF 
	- LAN所有的节点都会收到这个ARP查询包
2.  B接收到ARP包，回复A自己的MAC地址
	- 用A的MAC地址进行单播发送
3. A在自己的ARP表中，缓存 IP-to-MAC地址映射关系

ARP表项有TTL，需要定期刷新维持，同时也是保持更新。

ARP是即插即用的：
- 节点自己创建ARP的表项
- 无需网络管理员的干预

**不同LAN（网络）之间的ARP运作**
假设要从A发送数据报到B，且A已知B的IP
![[Pasted image 20231018092753.png]]
1. A对比B的IP后发现B在另一个子网中，因而查询自己的默认网关路由器IP：111.111.111.110
2. A通过ARP表找到默认网关路由器IP对应的MAC地址
3. A将数据报封装到帧中，并添加源MAC地址为自己，目标MAC地址为默认网关MAC地址
![[Pasted image 20231018092957.png]]
4. 默认网关R接收到帧后，从中抽取出数据报，得到目标IP地址
5. R查找转发表，得到需要转发的接口，得到该接口的MAC地址
6. R查找ARP表，得到目标IP地址的MAC地址
7. R将数据报封装到帧中，进行转发
![[Pasted image 20231018093214.png]]
8. 最后B就收到了来自A的数据报

## 以太网
**以太网物理拓扑**
![[Pasted image 20231018104103.png]]

**以太网帧结构**
![[Pasted image 20231018101644.png]]
前同步码（8字节）：
- 同步码的前7字节的值都是10101010；最后一个字节是10101011。
- 用来同步接收方和发送方的时钟速率
- 使得接收方将自己的时钟调到发送端的时钟，从而可以按照发送端的时钟来接收所发送的帧

目的地址/源地址：6字节的MAC地址

类型：指出高层协（大多情况下是IP，但也支持其它网络层协议Novell IPX和AppleTalk）

数据：承载了 IP数据报。
- 以太网的最大传输单元（MTU）是1500字节。这意味着如果IP数据报超过了 1500字节，则主机必须将该数据报分片。
- 数据字段的最小长度是46字节。这意味着如果IP数据报小于46字节，数据报必须被填充到46字节。

CRC码：循环冗余检错码，用于检测帧是否出错。

**以太网提供的服务**
![[Pasted image 20231018102746.png]]

## 交换机
**集线器**
集线器要求一个端口收，然后向所有端口发，因而连接到一个集线器的所有站点处在一个网段中，处在一个碰撞域中。

因而集线器在物理上是一个星型结构，在逻辑上是一个总线结构（向所有端口发）。
![[Pasted image 20231018104151.png]]

**交换机**
![[Pasted image 20231018105300.png]]
交换机与集线器的最大不同就是，交换机具有选择转发功能，而集线器只能全部转发（广播）

**交换机转发与过滤**
![[Pasted image 20231018111333.png]]
这里就体现了帧在交换机表中的匹配选择：
1. 匹配到的端口就是该帧进入的入口，就直接过滤。因为该帧已经在自己的网段中进行了广播
2. 匹配到的端口不是该帧进入的入口，进行转发
3. 没有任何匹配的端口，就直接进行广播

**交换机自学习**
![[Pasted image 20231018111727.png]]
因而交换机是即插即用设备（plug-and-play  device），不需要进行配置。

**交换机性质**
- 消除碰撞。交换机缓存帧并且决不会在网段上同时传输多于一个帧。因而MAC协议的作用被弱化。
- 全双工。可以在一个接口上发送和接收。
- 异质的链路。交换机将链路彼此隔离，因此局域网中的不同链路能够以不同的速率运行，并且能够在不同的媒体上运行。
- 交换机内无碰撞。选择转发使得交换机可以同时处理多个接口的转发。


