# 导论
## 网络层服务
- 在发送主机和接收主机对之间传送段（segment）
- 在发送端将段封装到数据报中 
- 在接收端，将段上交给传输层实体 
- 网络层协议存在于每一个主机和路由器 （不包括链路层交换机）
- 路由器检查每一个经过它的IP 数据报的头部（用于选择路径）

## 网络层转发与路由
![[Pasted image 20231002091853.png]]
转发是数据平面的功能，路由是控制平面的功能。

## 数据平面、控制平面
![[Pasted image 20231002092534.png]]
传统方式下路由器只会有转发这一个动作，而在SDN方式下，路由器可以有多个动作，比如阻止、泛洪（向所有出路发送）、修改字段，这样就使得整个网络变得可编程。

**传统方式**
传统方式下数据平面和控制平面都集中在一个路由器中，每一个路由器的路由算法元件在控制平面进行交互计算，从而得出路由表，很显然这是一个分布式的过程。

路由选择算法计算出本地转发表后（将在控制平面一章中讲解），数据平面根据IP数据报头部值和转发表匹配后，转发到对应输出链路。

传统方式是一个僵化的方式，一旦设置就难以改变。

**SDN方式**
网络中存在一个集中的SDN服务器，负责与所有路由器进行交互，集中式算出每个路由器的流表后，发送给每个路由器。

这样所有路由器的行为都是可以改变的，因为只需要在集中服务器上进行修改即可。

## 网络服务模型
网络层提供一种尽力而为的服务。
![[Pasted image 20231002095627.png]]

# 路由器组成
## 路由器结构
![[Pasted image 20231002100040.png]]
实际上在路由器中，输入端口和输出端口是整合在一起的。

## 输入端口
![[Pasted image 20231002101614.png]]

## 匹配方式
![[Pasted image 20231002103904.png]]
因为一个路由器中不可能存储所有IP地址的转发表，因而采用前缀就相当于为一个范围内的IP地址分配转发端口。


## 交换结构
![[Pasted image 20231002104205.png]]

**通过内存交换**
![[Pasted image 20231002104653.png]]
在这种情况下，如果内存带宽为每秒可写进内存或从内存读出最多B个分组，则总的转发吞吐量（分组从输入端口被传送到输出端口的总速率）必然小于B/2。因为一个分组使用了两次总线。

也要注意到不能同时转发两个分组，即使它们有不同的目的端口，因为经过共享系统总线一次仅能执行一个内存读/写。

**通过总线交换**
![[Pasted image 20231002104709.png]]
让输入端口为分组预先计划一个交换机内部标签（首部），指示本地输出端口，使分组在总线上传送和传输到输出端口。该分组能由所有输出端口收到，但只有与该标签匹配的端口才能保存该分组。然后标签在输出端口被去除，因为其仅用于交换机内部来跨越总线。

总线一次只能传输一个分组，因而交换带宽受总线速率限制。

**通过互联网络交换**
![[Pasted image 20231002105213.png]]
当某分组到达端口 A,需要转发到端口 Y时，交换机控制器闭合总线A和Y交叉部位的交叉点，然后端口 A在其总线上发送该分组，该分组仅由总线Y接收。

注意到来自端口 B的一个分组在同一时间能够转发到端口 X，因为A到Y和B到X的分组使用不同的输入和输岀总线。

因而互联网络交换能够并行转发多个分组，是非阻塞式的。

## 输出端口
![[Pasted image 20231002105555.png]]

## 调度机制
定义：选择下一个要通过链路传输的分组
策略：
1. FIFO
2. 优先权调度
3. Round Robin (RR) scheduling
4. Weighted Fair Queuing (WFQ)

# IP协议
## IP数据报格式
![[Pasted image 20231002113913.png]]
关键字段如下：
- 版本号。这4比特规定了数据报的IP协议版本。可以确定时IPv4还是IPv6。
- 首部长度。单位是一个字也就是4个字节。从图中就可以看出，除去Options，最少有20个字节。
- 服务类型。这个用的比较少了。
- 数据报长度。这是IP数据报的总长度（首部加上数据），以字节计。因为该字段长为16比特，所以IP数据报的理论最大长度为65 535字节。然而，数据报很少有超过1500字节的，该长度使得IP数据报能容纳最大长度以太网帧的载荷字段。
- 标识、标志、片偏移。这三个字段与所谓IP分片有关。
- 寿命（TTL）。用来确保数据报不会永远（如由于长时间的路由选择环路）在网络中循环。每过一个路由器减一。
- 协议。该字段值指示了 IP数据报的数据部分应交给哪个特定的运输层协议。值为6表明数据部分要交给TCP，而值为17表明数据要交给UDP。
- 首部检验和。用于帮助路由器检测收到的IP数据报中的比特错误。与之前提到的检验和计算方式相同。注意只判断头部。
- 源和目的IP地址。通常源主机通过DNS查找来决定目的地址。
- 选项。选项字段允许IP首部被扩展。
- 数据（有效载荷）。

## 分片与重组
IP数据报在传输中经过的链路不同，对应的MTU（链路层帧所携带的最大数据长度）不同，因而需要在传输过程中将IP数据报进行分片：
- 一个数据报被分割成若干个小的数据报
	- 相同的ID
	- 不同的偏移量
	- 最后一个分片标记为0
- “重组”只在最终的目标主机进行
- IP头部的信息被用于标识，排序相关分片

![[Pasted image 20231003095817.png]]
偏移以8个字节计算，因而划分的时候也要以8个字节为切分。 

## IP编址
IP地址：32位标识，对主机或路由器的接口编址。一个IP地址和一个接口相关联。
接口：主机/路由器和物理链路的连接处
- 路由器通常拥有多个接口 
- 主机也有可能有多个接口 
- IP地址和每一个接口关联

## 子网
- 一个子网内的节点，其IP地址高位部分相同
- 一个子网内的节点，无需路由器介入，各主机可以在物理上相互直接到达

![[Pasted image 20231003103446.png]]

## IP地址分类
![[Pasted image 20231003105646.png]]
![[Pasted image 20231003105628.png]]
![[Pasted image 20231003112811.png]]
全0和全1是不会使用的，这是特殊IP。全0用于标识主机，全1用于广播。

## 特殊IP与内网IP
**网络地址**
因特网上的每个网络都有一个IP地址，其主机号部分为“0”。
该地址用于标识网络，不能分配给主机，因此不能作为数据的源地址和目的地址。
- A类网络的网络地址为：Network-number.0.0.0。例如，120.0.0.0；
- B类网络的网络地址为：Network-number.0.0。例如，139.22.0.0；
- C类网络的网络地址为：Network-number.0。例如，203.120.16.0。

**直接广播地址**
直接广播（Direct Broadcast Address）：向某个网络上所有的主机发送报文。
TCP/IP规定，主机号各位全部为“1”的IP地址用于广播，叫作广播地址。
直接广播地址只能作为目的地址。
- A类网络的直接广播地址为：Network-number.255.255.255。例如，120.255.255.255；
- B类网络的直接广播地址为：Network-number.255.255。例如，139.22.255.255；
- C类网络的直接广播地址为：Network-number.255。例如，203.120.16.255。

**受限广播地址**
直接广播要求发送方必须知道信宿网络的网络号。但有些主机在启动时，往往并不知道本网络的网络号，这时候如果想要向本网络广播，只能采用受限广播地址（Limited Broadcast Address）。
TCP/IP规定，32比特全为“1”的IP地址用于本网络内的广播。即255.255.255.255

**本网络地址**
TCP/IP协议规定，网络号各位全部为“0”时表示的是本网络。本网络地址分为两种情况：本网络特定主机地址和本网络本主机地址。

本网络特定主机地址的一般表达式为：
{\<Network-number>,\<Host-number>}={0, \<Host-number>}

本网络本主机地址的一般表达式为：
{\<Network-number>，\<Host-number>}={0, 0}

**回环地址**
A类网络地址127.X.X.X被用作环回地址。

当使用环回地址作为目标地址发送数据时，数据将不会被发送到网络上，而是在数据离开网络层时将其回送给本机的有关进程。

一般使用127.0.0.1

**事实上网络地址全0就表示本网络，主机地址全0就表示本主机**

**内网（专用）地址**
![[Pasted image 20231003114205.png]]
内网地址无法与Internet通信，但可以通过某种方法实现，这就是NAT（后面会讲）

## IP编制：CIDR
CIDR：无类域间路由。由于传统ABC类地址不能满足一般化的需求，采用CIDR可以自己划分网络和主机，并采用**子网掩码**标识32位地址中哪些是网络位哪些是主机位。

![[Pasted image 20231003115803.png]]
**子网掩码**
![[Pasted image 20231003115852.png]]

## 转发表和转发算法
![[Pasted image 20231003120017.png]]
其中默认表项就是默认网关，其实就是该路由器的出口，同时也是网络边缘设备接入网络核心的入口。

## DHCP
![[Pasted image 20231003164559.png]]
通常会提供四个信息：
- 主机分配到的IP地址
- 子网掩码 (指示地址部分的网络号和主机号)
- 本地DNS服务器的域名和IP地址
- 默认网关（第一跳路由器地址）

流程如下：
![[Pasted image 20231003170357.png]]

## 层次编制：路由聚集
在最上层的机构拿到IP地址后，可以进行划分，给下面每个小机构在划分多个IP地址，这样就形成了一个层次结构。无论收发，都可以根据IP地址中的网络位（前缀）进行判断。
![[Pasted image 20231003172619.png]]

