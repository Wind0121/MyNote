# 主存管理概述
## 主存分片管理
分片方式有两种：
- 大小不等：
	- 按区分配
	- 按段分配
- 大小相等：
	- 按页分配

系统为每个用户提供一个虚拟地址空间

# 主存管理功能
## 基本概念
- 物理地址是计算机主存单元的真实地址，⼜称为绝对地址和实地址 
- 物理地址的集合所对应的空间组成了主存空间。 
- ⽤户的程序地址 (指令地址或操作数地址)均为逻辑地址。 
- 程序地址空间：⽤户程序所有的逻辑地址集合对应的空间。

## 虚拟存储器
- 由OS和硬件相配合完成主存和辅存之间信息的动态调度，这样⼦好像OS提供了⼀个存储容量⽐实际主存⼤得多的存储器，这个存储器称之为虚拟存储器 
	- 逻辑地址与物理地址分开 
	- 存储空间与虚地址空间分开 
	- 提供地址变换机构 
- ⽤户通过逻辑地址访问虚拟存储器，接着OS和硬件动态调度，将虚拟存储器的逻辑地址转化为物理地址来访问实际的主存

## 地址映射
实现逻辑地址到物理地址转换的过程，称为地址映射

地址映射方式：
- 编译的时候确定地址映射的关系
- 静态地址映射：在程序装⼊的时候确定地址映射关系，由重定位装⼊程序确定
- 动态地址映射：在程序运⾏时确定地址映射关系，随着每条指令和数据的访问⾃动地连 续地进⾏地址映射，这种地址变换⽅式称为动态地址映射，由硬件实现（重定位寄存器）

## 主存分配
- 主存资源信息块：等待队列；空闲区队列；主存分配程序

## 存储保护
- 主存按照区的模式分配给各⽤户程序使⽤，每个⽤户程序必须在给定的存储区域内活动即可
- 上下界保护：有上界寄存器和下界寄存器，程序访问内存只能使⽤在上界寄存器和下界寄存器之间的区域(物理地址)
- 基址、限⻓寄存器保护：有限⻓寄存器和基址寄存器，基址寄存器表示程序在内存中存储空间从何开始，限⻓寄存器限制程序访问的逻辑地址，逻辑地址<限⻓寄存器的值

# 分区存储管理
## 动态分区存储管理技术
在运⾏程序的过程中，建⽴分区，依照⽤户请求的⼤⼩分配分区
![[Pasted image 20231129093601.png]]

在系统运行相当长一段时间后，就会出现很多不连续的的小空闲区，这会导致主存的浪费
![[Pasted image 20231129093612.png]]

## 分区分配机构
- 主存资源信息块（m_rib）
	- 等待队列头指针 
	- 空闲区队列头指针 
	- 主存分批程序⼊⼝地址
- 分区描述器（PD）
	- flag为0为空闲区，flag为1是已占⽤区
	- size是分区⼤⼩
	- next：如果是空闲区，那就是下⼀个空闲区的⾸地址，如果是已分配区，这⼀项为0
![[Pasted image 20231129093705.png]]

这里就是按照分区描述器中的字段，例如：56KB表示空闲块地址，0表示空闲，10KB表示分区大小，226KB表示下一个空闲块的地址
![[Pasted image 20231129093837.png]]
## 分区分配与放置策略
分区回收的思路：
- 检查释放分区的在主存中的连接情况
- 如果上下邻接空闲区，则合并成为⼀个新的空闲区
- 若回收分区不与任何空闲去相邻接，建⽴⼀个新的空闲区，加⼊到空闲队列

三种放置策略：
- ⾸次适应算法：将输⼊的程序放置到主存⾥⾜够装⼊它的**地址最低**的空闲区中
	- 放⼊⼀个能放⼊这个程序的空闲块，空闲块地址越低越好
	- 空闲区队列：空闲区地址由低到⾼排序
- 最佳适应算法：将输⼊的程序放置到主存中与它**所需⼤⼩最接近**的空闲区中
	- 放⼊⼀个能放⼊这个程序的空闲块，空闲块⼤⼩越⼩越好
	- 空闲区队列：由⼩到⼤排序
- 最坏适应算法：将输⼊的程序放置到主存中与它**所需⼤⼩差距最⼤**的空闲区中
	- 放⼊⼀个能放⼊这个程序的空闲块，空闲块⼤⼩越大越好
	- 空闲区队列：由⼤到⼩排序

![[Pasted image 20231129094411.png]]

## 碎片问题
- 拼接技术
	- 移动存储器中某些已分配区中的信息，使得本来分散的空闲区连接成⽐较⼤的空闲区
- 拼接时机
	- 在某个分区回收时立即拼接
	- 当找不到足够大的空闲区，而空闲区的存储总量大于程序需要的空间时，进行拼接
	- 第二种方案的拼接频率比第一种小很多
- 拼接技术缺点
	- 消耗系统资源，移动已分配区信息需要耗费大量CPU时间
	- 当系统进行拼接时，必须停止其他所有工作
	- 有时拼接花费的系统开销大于拼接所得到的效益

# 页式存储管理
## 基本概念
- 程序的地址空间(虚拟地址空间)被等分成⼤⼩相等的⽚，称为⻚⾯，⼜称为虚⻚
- 主存(物理地址空间，实地址空间)⼜被分成⼤⼩相等的⽚，称为主存块，⼜称为实⻚
- 为了实现从地址空间到物理主存的映象，系统建⽴的记录⻚与内存块之间对应关系的地址变换的机构称为⻚⾯映像表，简称⻚表。(程序逻辑地址中虚⻚号与物理主存中实⻚号之间的变换映射)
	- 程序逻辑地址有虚⻚号，内存的物理地址⾥⾯为实⻚号，程序就通过虚⻚号替换成实⻚号来找到程序或数据实际的位置
	- 总的来说，是记录⻚和块之间对应关系的地址变换的结构

## ⻚式地址变换
**页表**
![[Pasted image 20231129102046.png]]

**虚地址结构**
- 高位为页号
- 低位为页内偏移

**页式地址变换**
- CPU给出操作数
- 分⻚机构⾃动把逻辑地址分成两部分⾼地址⻚号为P，低地址⻚内偏移为W
- 根据⻚表始址寄存器指示的⾸地址PTBR，加上⻚号P，就是该⻚号对应的⻚表项的地址(PTBR+P 就是这个⻚对应的⻚表项地址)，获得物理块块号B
- 将块号B和⻚内偏移量并在⼀起，就形成了主存地址(物理地址)
![[Pasted image 20231129102311.png]]

**联想存储器（快表）**
- 先在快表中查找有没有相关⻚表项记录，快表是⼀个独⽴的硬件，独⽴于内存之外
- 如果快表中没有，只能查找存储在内存中的⻚表，然后把查出来的⻚表项记录在快表⾥⾯
![[Pasted image 20231129102539.png]]

## 请调⻚⾯的机制

