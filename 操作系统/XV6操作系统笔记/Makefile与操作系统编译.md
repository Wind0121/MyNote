# 概述
整个XV6分为操作系统内核与用户应用程序两部分，它们都在qemu，也就是一个C程序模拟的虚拟机上运行。

# 操作系统内核的编译
在XV6文件中，kernel目录下的文件都属于内核文件，Makefile将整个kernel目录下的文件编译成目标文件（\*.o），然后通过链接器将所有目标文件链接成可执行文件kernel，这就是操作系统内核。

# 如何链接
![[Pasted image 20231226172400.png]]
- 根据Makefile中的内容，生成kernel可执行程序的依赖项是所有内核文件都编译成目标文件、准备好kernel.ld文件、user目录下的initcode文件。然后会在命令行中指令高亮部分的指令。
- 首先进行链接，链接器通过链接脚本（.ld文件）将所有内核目标文件链接成可执行文件kernel。
- 然后进行反汇编，通过OBJDUMP指令生成一个kernel.asm，这就是可执行文件的汇编形式。
- 然后再次进行反汇编，生成了一个kernel可执行文件的所有段地址，也就是kernel.sym文件。

**请注意**：这里使用的编译器、汇编器、链接器都是riscv下的工具，这些都已经在Makefile中指明，通过XV6的编译启动输出也可以看出这一点。
![[Pasted image 20231226173002.png]]

# 操作系统内核编译文件
通过kernel.asm文件我们可以看到整个操作系统内核的汇编形式，也可以看到内核的入口地址为0x80000000。qemu（虚拟机）装载操作系统时就会将其装载到这个内存地址。
![[Pasted image 20231226173217.png]]

# 用户应用程序编译
用户应用程序会随着文件镜像一同编译，然后装入qemu（虚拟机）的物理存储，这样内核的文件系统就可以读取这些应用程序，并进行执行。

通过Makefile可以看出，fs.img依赖用户应用程序文件以及mkfs文件，之后会通过mkfs程序生成整个fs.img文件。
![[Pasted image 20231226173458.png]]